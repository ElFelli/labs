<!doctype html>
<head>
  <title></title>
  <script src="/polymer/polymer/polymer.js"></script>
  <link rel="import" href="/polymer/polymer-elements/polymer-layout/polymer-layout.html">
  <link rel="import" href="/polymer/polymer-elements/polymer-ajax/polymer-ajax.html">
  <link rel="import" href="/polymer/polymer-ui-elements/polymer-ui-toolbar/polymer-ui-toolbar.html">
  <link rel="import" href="/polymer/polymer-ui-elements/polymer-ui-icon-button/polymer-ui-icon-button.html">
  <link rel="import" href="/polymer/polymer-ui-elements/polymer-ui-menu/polymer-ui-menu.html">
  <link rel="import" href="/polymer/polymer-ui-elements/polymer-ui-menu-item/polymer-ui-menu-item.html">
  <link rel="import" href="/polymer/more-elements/code-mirror/code-mirror.html">
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    x-app {
      display: block;
      height: 100%;
    }
  </style>
</head>

<body theme="polymer-ui-dark-theme">

  <x-app></x-app>

  <polymer-element name="x-app">
    <template>
      <style>
        iframe {
          border: 0;
          width: 100%;
          height: 100%;
        }
        #preview {
          width: 400px;
          position: relative;
        }
      </style>

      <polymer-layout vertical></polymer-layout>
      
      <polymer-ui-toolbar>
        <button on-click="click">Test</button>
        <polymer-ui-icon-button icon="settings" on-tap="click"></polymer-ui-icon-button>
      </polymer-ui-toolbar>
      
      <div flex>
        <polymer-layout horizontal></polymer-layout>
        <polymer-ui-menu>
          <polymer-ui-menu-item on-tap="itemTap">Toolbar</polymer-ui-menu-item>
          <polymer-ui-menu-item on-tap="item2Tap">Icon Button</polymer-ui-menu-item>
        </polymer-ui-menu>
        <code-mirror id="code" flex></code-mirror>
        <div id="preview">
          <iframe id="frame" src="project/index.html"></iframe>
        </div>
      </div>

      <polymer-ajax id="ajax" url="file/foo.html" method="POST"></polymer-ajax>
      <polymer-ajax url="project/index.html" handleAs="text" response="{{text}}" auto></polymer-ajax>
    </template>
    <script>
      Polymer('x-app', {
        text: '',
        created: function() {
          this.$.code.mirror.on('change', this.codeChange.bind(this));
        },
        enteredDocument: function() {
          // code mirror manages it's size prematurely
          this.$.code.async('refresh', null, 100);
        },
        textChanged: function() {
          this.$.code.mirror.setValue(this.text);
        },
        codeChange: function() {
          this.updateJob = this.job(this.updateJob, this.save, 500);
        },
        click: function() {
          this.save();
        },
        itemTap: function() {
          this.$.code.mirror.replaceSelection('<polymer-ui-toolbar></polymer-ui-toolbar>');
        },
        item2Tap: function() {
          this.$.code.mirror.replaceSelection('<polymer-ui-icon-button></polymer-ui-icon-button>');
        },
        save: function() {
          this.saveText();
          // TODO(sjmiles): this should be an event or callback from saveText, but it's
          // inconvenient; need to develop a better answer here
          this.async(this.updatePreview, null, 100);
        },
        saveText: function() {
          this.$.ajax.xhrArgs = {
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            }
          };
          this.$.ajax.params = {
            html: this.$.code.mirror.getValue()
          };
          this.$.ajax.go();
        },
        updatePreview: function() {
          this.$.frame.contentWindow.location.reload(true);
        }
      });
    </script>
  </polymer-element>
</body>
</html>
