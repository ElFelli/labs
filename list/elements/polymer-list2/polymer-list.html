<link rel="import" href="../polymer-virtual-list/polymer-virtual-list.html">

<polymer-element name="polymer-list" extends="polymer-virtual-list" attributes="data">
  <script>
    Polymer('polymer-list', {
      ready: function() {
        this.data = [];
        this.listData = [];
        this.super();
      },
      enteredView: function() {
        this.template = this.querySelector('template');
      },
      dataChanged: function() {
        this.count = this.data.length;
        //console.log('dataChanged', this.count);
      },
      generatePageContent: function(page, start, end) {
        this.super();
        // add a content w/select into this page
        var c = document.createElement('content');
        c.select = '.page' + page.pageNum;
        page.appendChild(c);
      },
      /*
        auto-generate a scope: 
        {root: template model, item: item data, page}
      */
      generateListData: function(info) {
        var start = info.start * this.pageSize;
        var end = Math.min(start + this.pageSize * this.numPages, this.count);
        this.fire('polymer-list-generate-data', {start: start, end: end});
        // produce data window
        for (var i=0, l=end-start; i<l; i++) {
          this.generateListDataItem(i, start+i);
        }
        if (l < this.listData.length) {
          this.listData.splice(l, this.listData.length - l);
        }
      },
      generateListDataItem: function(index, dataIndex) {
        var item = this.data[dataIndex];
        if (this.useFreshData) {
          this.listData[index] = {
            item: item,
            root: this.rootData
          };
        } else {
          if (!this.listData[index]) {
            this.listData[index] = {
              item: Polymer.extend({}, item),
              root: this.rootData
            };
          } else {
            var d = this.listData[index];
            // clear previous value, ug
            for (var a in d.item) {
              d.item[a] = undefined;
            }
            Polymer.extend(d.item, item);
          }
        }
        this.listData[index].page = 'page' +
            Math.floor(dataIndex / this.pageSize);
      },
      templateChanged: function() {
        if (!this.template) {
          return;
        }
        this.rootData = this.template.templateInstance.model;
        var content = this.template.ref.content;
        // why isn't this necessary?
        /*if (content.bindingMap_) {
          console.log(content.bindingMap_);
          content.bindingMap_ = null;
        }*/
        // add 'page' element to template
        var page = document.createElement('div');
        page.setAttribute('class', '{{page}}');
        while (content.firstChild) {
          page.appendChild(content.firstChild);
        }
        content.appendChild(page);
        // set template to repeat
        this.template.bind('repeat', this, 'listData');
      },
      listDataChanged: function() {
        this.template.templateInstance.model.listData = this.listData;
      },
      invalidatePages: function(info) {
        this.generateListData(info);
        this.super(arguments);
        if (!this.fixedHeight || !this.rowHeight) {
          this.onMutation(this, function() {
            this.invalidate(info);
          });
        }
      },
      mutationNodeForPage: function(page) {
        return this;
      },
      findRowOnPage: function(page, index) {
        return this.querySelectorAll('.page' + page.pageNum)[index];
      }
    });
  </script>
</polymer-element>