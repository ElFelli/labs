<link rel="import" href="../../../polymer-ui-elements/polymer-ui-menu/polymer-ui-menu.html">
<link rel="import" href="../../../polymer-ui-elements/polymer-ui-menu-item/polymer-ui-menu-item.html">

<polymer-element name="x-dropdown-menu" attributes="value multi" on-tap="tapHandler">
  <template>
    <link rel="stylesheet" href="x-dropdown-menu.css">
    <button class="dropdown-button" dropdown-toggle on-tap="toggle">
      <div>{{output}}</div><img src="arrow_down.png">
    </button>
    <div class="menu-container" hidden?="{{!show}}">
      <polymer-ui-menu id="menu" multi="{{multi}}" valueattr="{{valueattr}}" on-polymer-select="selectionChange">
        <content></content>
      </polymer-ui-menu>
    </div>
  </template>
  <script>
    Polymer('x-dropdown-menu', {
      multi: false,
      show: false,
      valueattr: 'label',
      toggle: function() {
        this.show = !this.show;
      },
      showChanged: function() {
        this.enableCaptureHandler(this.show);
      },
      selectionChange: function(e) {
        var s = this.$.menu.selection;
        if (this.multi) {
          this._value = [];
          s.forEach(function(item) {
            this._value.push(item[this.valueattr]);
          }.bind(this));
        } else {
          this._value = s[this.valueattr];
        }
      },
      get value() {
        return this._value || null;
      },
      set value(value) {
        this._value = value;
        this.asyncMethod('updateSelection');
      },
      valueChanged: function() {
        this.output = this.multi ? this.value.join(',') : this.value;
      },
      updateSelection: function() {
        if (this.multi) {
          this.value.forEach(function(v) {
            this.$.menu.valueToSelection(v);
            }.bind(this));
        } else {
          this.$.menu.valueToSelection(this.value);
        }
      },
      enableCaptureHandler: function(enable) {
        this.captureHandlerListener = this.captureHandlerListener || 
            this.captureHandler.bind(this);
        document[enable ? 'addEventListener' : 'removeEventListener'](
            'tap', this.captureHandlerListener, true);
      },
      captureHandler: function(e) {
        if ((this != e.target) && !(this.contains(e.target))) {
          this.autoCloseJob = this.job(this.autoCloseJob, function() {
            this.show = false;
          });
        }
      },
      tapHandler: function(e) {
        if (e.target && e.target.hasAttribute('dropdown-toggle')) {
          this.toggle();
        } else {
          if (this.autoCloseJob) {
            this.autoCloseJob.stop();
            this.autoCloseJob = null;
          }
        }
      }
    });
  </script>
</polymer-element>