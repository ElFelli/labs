<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-app" on-keyup="keyup">
  <template>
    <style>      
      .top {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 260px;
        left: 0;
        overflow: auto;
      }
      .bottom {
        position: absolute;
        height: 244px;
        right: 8px;
        bottom: 8px;
        left: 8px;
        overflow: auto;
      }
      .left {
        position: absolute !important;
        top: 0;
        width: 264px;
        bottom: 0;
        left: 0;
        background-color: white !important;
      }
      .middle {
        position: absolute;
        top: 0;
        right: 350px;
        bottom: 0;
        left: 264px;
        background-color: white;
        overflow: hidden;
      }
      .right {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 350px;
        overflow: auto;
      }
      .fit {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
    </style>
    <div class="top">
      <g-sidebar class="left" label="Palette">
        <tk-palette id="palette" class="fit" on-palette-drag-start="paletteDragStart" on-palette-drag="paletteDrag" on-palette-drag-end="paletteDragEnd"></tk-palette>
      </g-sidebar>
      <tk-canvas id="canvas" tabIndex="-1" class="middle" on-tap="canvasTap" on-pointerup="canvasDrop"></tk-canvas>
      <tk-inspector id="inspector" class="right" on-parent-element="selectParentAction" on-delete-element="deleteElement"></tk-inspector>
    </div>
    <div class="bottom">
      <ajaxorg-ace id="source" mode="html" theme="merbivore" readonly wrap></ajaxorg-ace>
    </div>
  </template>
  <script>
    Toolkit.register(this, {
      paletteDragStart: function(event, detail) {
        this.dragType = detail;
        this.createNew(detail);
      },
      createNew: function(tag) {
        var html = this.$.palette.getArchetype(tag);
        if (html) {
          var div = document.createElement('div');
          div.innerHTML = html;
          neo = div.firstElementChild;
        } else {
          neo = document.createElement(tag);
        }
        neo.id = tag.split('-').pop().toLowerCase();
        neo.style.position = 'absolute';
        this.$.canvas.appendChild(neo);
        this.$.inspector.element = neo;
        this.$.inspector.propOptions = this.$.palette.getPropOptions(tag);
        this.neo = neo;
      },
      paletteDrag: function(event, detail) {
        if (this.neo) {
          var x = detail.x - this.$.canvas.offsetLeft - 24;
          var y = detail.y - this.$.canvas.offsetTop - 24;
          var p = this.$.canvas.snap(x, y);
          this.neo.style.left = p.x + 'px';
          this.neo.style.top = p.y + 'px';             
        }
      },
      paletteDragEnd: function() {
        // if the drag ends before neo has dropped on canvas, remove him
        if (this.neo) {
          this.neo.parentNode.removeChild(this.neo);
          this.neo = null;
        }
      },
      canvasDrop: function() {
        // if dropped on canvas, let neo stay
        this.neo = null;
        this.canvasChange();
      },
      deleteElement: function() {
        var e = this.$.inspector.element;
        if (e) {
          e.parentNode.removeChild(e);
          this.$.inspector.element = null;
          this.canvasChange();
        }
      },
      canvasTap: function(event) {
        this.inspectTarget(event);
      },
      inspectTarget: function(event) {
        var t = event.target;
        if (t && t !== this.$.canvas) {
          this.$.inspector.element = t;
        }
      },
      selectParentAction: function() {
        var e = this.$.inspector.element;
        if (e && e.parentNode) {
          e = e.parentNode;
          if (e === this.$.canvas) {
            e = null;
          }
          this.$.inspector.element = e;
        }
      },
      keyup: function(event) {
        if (event.keyCode === 27) {
          this.selectParentAction();
        }
      },
      canvasChange: function() {
        var html = this.$.canvas.innerHTML;
        html = html.replace(/ style="[^"]*"/g, '');
        this.$.source.value = html_beautify(html);        
      }
    });
  </script>
</element>
