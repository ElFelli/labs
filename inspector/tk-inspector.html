<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<element name="tk-inspector">

  <template>
    <style>
      @host {
        * {
          border: 1px dotted gray;
        }
      }
      #interior {
        position: absolute;
        top: 8px;
        left: 8px;
        bottom: 8px;
        right: 8px;
      }
    </style>
    <div id="interior">
      <g-icon-button src="assets/ic_cancel_darkalt.png" on-click="deleteElement" 
          style="vertical-align: middle;"></g-icon-button>
      <b>{{name}}</b>
      <g-icon-button src="assets/ic_home_darkreg.png" on-click="selectParentElement" 
          style="vertical-align: middle; float: right"></g-icon-button>
      <hr/>
      <template repeat="{{properties}}">
        <tk-property-editor property="{{}}"></tk-property-editor>
      </template>
    </div>
  </template>

  <script>
    var blacklist = {isToolkitElement: 1};
    Toolkit.register(this, {
      element: null,
      properties: null,
      propOptions: null,
      name: '',
      elementChanged: function() {
        this.properties = this.reflectProperties(this.element);
        this.name = this.element && this.element.localName || '';
      },
      reflectProperties: function(element) {
        var props = [];
        if (element) {
          var p = element.__proto__;
          while (p && p !== HTMLElement.prototype/*&& p.isToolkitElement*/) {
            var k = Object.keys(p);
            k.forEach(function(k) {
              var v = this.element[k];
              if (v !== null && v !== undefined 
                  && typeof v !== 'function' && typeof v !== 'object'
                  /*&& element.propertyIsEnumerable(k)*/ && !blacklist[k]) {
                props.push({
                  name: k,
                  value: v,
                  options: this.propOptions && this.propOptions[k],
                  obj: element
                });
              }
            }, this);
            p = p.__proto__;
          }
          var more = [];
          if (!this.element.firstElementChild) {
            more.push('textContent');
          }
          more.push('id');
          more.forEach(function(k) {
            var v = this.element[k];
            if (typeof v !== 'function' && typeof v !== 'object') {
              props.push({
                name: k,
                value: v,
                obj: element
              });
            }
         }, this);
       }
       return props;
      },
      deleteElement: function() {
        this.send('delete-element');
      },
      selectParentElement: function() {
        this.send('parent-element');
      }
    });
  </script>

</element>


<element name="tk-property-editor" attributes="property">

  <template>
    <style>
      @host {
        *{
          white-space: nowrap;
        }
      }
      .property-name {
        display: inline-block;
        width: 50%;
        padding: 4px;
        text-align: right;
        text-overflow: ellipsis;
        vertical-align: middle;
        overflow: hidden;
      }
    </style>
    <span class="property-name">{{property.name}}: </span><content></content>
  </template>

  <script>
    Toolkit.register(this, {
      property: null,
      editor: null,
      editorTypes: {
        'boolean': 'tk-boolean-property-editor',
        'string': 'tk-string-property-editor',
        any: 'tk-string-property-editor'
      },
      propertyChanged: function() {
        var type = this.editorTypes[typeof this.property.value];
        if (this.property.options) {
          type = 'tk-select-property-editor';
        }
        this.editor = document.createElement(type || this.editorTypes.any);
        this.editor.property = this.property;
        //Toolkit.bindProperties(this.editor, 'liveValue', this.property.obj, this.property.name);
      },
      editorChanged: function(inOld) {
        if (inOld) {
          inOld.parentNode.removeChild(inOld);
        }
        this.appendChild(this.editor);
      }
    });
  </script>

</element>


<element name="tk-abstract-property-editor">

  <script>
    Toolkit.register(this, {
      property: null,
      liveValue: null,
      propertyChanged: function() {
        this.liveValue = this.property.value;
      },
      inputChange: function() {
        this.property.value 
            = this.property.obj[this.property.name] 
            = this.liveValue;
      }
    });
  </script>

</element>


<element name="tk-string-property-editor" extends="tk-abstract-property-editor">

  <template>
    <input type="{{type}}" value="{{liveValue}}" on-change="inputChange" style="width: 40%; -webkit-user-select: all; -moz-user-select: all;"><br/>
  </template>

  <script>
    Toolkit.register(this, {
      type: "text",
      propertyChanged: function() {
        if (String(this.property.value).slice(0, 1) == '#') {
          this.type = "color"
        }
        this.super();
      }
    });
  </script>

</element>


<element name="tk-boolean-property-editor" extends="tk-abstract-property-editor">
  
  <template>
    <input type="checkbox" checked="{{liveValue}}" on-click="inputChange"><br/>
  </template>

  <script>
    Toolkit.register(this);
  </script>

</element>


<element name="tk-select-property-editor" extends="tk-abstract-property-editor" attributes="options">
  
  <template>
    <select id="select" on-change="inputChange">
      <template repeat="{{options}}">
        <option>{{}}</option>
      </template>
    </select><br/>
  </template>

  <script>
    Toolkit.register(this, {
      propertyChanged: function() {
        this.options = this.property.options;
      },
      inputChange: function() {
        this.liveValue = this.$.select.value;
        this.super();
      }
    });
  </script>

</element>
